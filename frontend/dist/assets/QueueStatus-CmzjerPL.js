import{_ as J}from"./_plugin-vue_export-helper-BCEt7Ct6.js";/* empty css                   *//* empty css                *//* empty css                    *//* empty css                             *//* empty css                  */import{r as g,W as O,F as X,a0 as Z,c as h,o as p,d as o,w as l,K as ee,I as f,m,f as te,a1 as ae,b as r,a2 as se,S as k,a3 as ne,a4 as re,l as c,v as d,V as oe,a5 as le,n as M,k as ie,t as ue,x as q,L as ce,a6 as de,a7 as ge,a8 as E}from"./index-DURBC1W6.js";const pe={class:"queue-status"},_e={class:"card-header"},ve={key:0},fe={class:"queue-info"},me={key:0,class:"charging-info"},he={class:"charging-time-info"},we={class:"time-item"},ye={class:"time-value"},Se={class:"time-item"},xe={class:"time-value"},Te={class:"time-item"},$e={class:"time-value"},be={class:"charging-progress"},ke={class:"action-buttons"},Ee={key:1},Ie={class:"no-queue-actions"},De={__name:"QueueStatus",setup(Me){const x=te(),a=g(null),T=g(!1),$=g(!1),_=g(!1),w=g(new Date),y=g(null),S=g(null),B=O(()=>{const s=w.value,t=s.getHours().toString().padStart(2,"0"),e=s.getMinutes().toString().padStart(2,"0"),n=s.getSeconds().toString().padStart(2,"0");return`${t}:${e}:${n}`}),v=async()=>{var s,t;T.value=!0;try{let e=!1,n=null;try{const i=await f.get("/users/queue/status");a.value=i.length>0?i[0]:null,e=!0}catch(i){n=i,console.log("主排队状态API失败，尝试备用路径");try{const u=await f.get("/charging/queue");a.value=u.length>0?u[0]:null,e=!0}catch{console.error("所有排队状态API路径都失败")}}if(!e&&n)throw n;console.log("当前队列状态:",a.value)}catch(e){console.error("获取排队状态失败:",e),m.error("获取排队状态失败: "+(((t=(s=e.response)==null?void 0:s.data)==null?void 0:t.detail)||"未知错误"))}finally{T.value=!1}},C=async()=>{$.value=!0;try{await v(),m.success("状态已刷新")}finally{$.value=!1}},P=async()=>{var s,t;try{await E.confirm("确定要取消排队吗？","取消确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),_.value=!0;try{await f.delete(`/charging/cancel/${a.value.id}`)}catch{console.log("尝试备用API路径"),await f.delete(`/users/charging/cancel/${a.value.id}`)}m.success("已取消排队"),await v()}catch(e){e!=="cancel"&&(console.error("取消排队失败:",e),m.error("取消排队失败: "+(((t=(s=e.response)==null?void 0:s.data)==null?void 0:t.detail)||"未知错误")))}finally{_.value=!1}},A=async()=>{var s,t;try{await E.confirm("确定要结束充电吗？","结束确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),console.log("正在结束充电，队列ID:",a.value.id),_.value=!0;let e;try{const n=`/charging/stop/${a.value.id}`;console.log("尝试API路径:",n),e=await f.post(n)}catch(n){console.log("主API路径失败，尝试备用路径");try{const i=`/users/charging/stop/${a.value.id}`;console.log("尝试备用API路径:",i),e=await f.post(i)}catch{throw console.error("所有API路径都失败"),n}}console.log("结束充电响应:",e),m.success("充电已结束"),E.alert(`
      <div style="text-align: center; padding: 10px;">
        <h3 style="margin-bottom: 15px;">充电已完成</h3>
        <p>充电量: ${((s=e.charging_amount)==null?void 0:s.toFixed(2))||"0.00"} 度</p>
        <p>充电时长: ${F(e.charging_duration||0)}</p>
        <p>费用: ${((t=e.total_fee)==null?void 0:t.toFixed(2))||"0.00"} 元</p>
      </div>
      `,"充电结果",{dangerouslyUseHTMLString:!0,confirmButtonText:"查看详单",callback:()=>{e.record_id?x.push({path:"/user/records",query:{record_id:e.record_id}}):x.push("/user/records")}}),await v()}catch(e){if(e!=="cancel"){console.error("结束充电失败:",e);let n="结束充电失败";e.response&&e.response.data&&(console.error("错误详情:",e.response.data),n+=": "+(e.response.data.detail||"未知错误")),m.error(n)}}finally{_.value=!1}},F=s=>{if(s==null)return"";const t=Math.floor(s),e=Math.round((s-t)*60);return`${t}小时${e?e+"分钟":""}`},Q=()=>{x.push("/user/charging")},V=()=>{if(!a.value)return"";switch(a.value.status){case"waiting":return"您正在排队中";case"charging":return"正在充电中";case"completed":return"充电已完成";default:return"状态未知"}},L=()=>{if(!a.value)return"info";switch(a.value.status){case"waiting":return"warning";case"charging":return"success";case"completed":return"info";default:return"info"}},N=()=>{if(!a.value)return"";switch(a.value.status){case"waiting":return"您的充电请求已提交，正在等候区等待。系统将为您分配最佳充电桩，请耐心等待。";case"queuing":return`您已被分配到${a.value.pile_name}，目前在队列中等待充电。`;case"charging":return`您的车辆正在${a.value.pile_name}充电中。您可以随时结束充电，按实际用电量计费。`;default:return""}},U=s=>{switch(s){case"waiting":return"warning";case"queuing":return"info";case"charging":return"success";case"completed":return"info";default:return"info"}},H=s=>{switch(s){case"waiting":return"等候区等待中";case"queuing":return"充电区排队中";case"charging":return"正在充电";case"completed":return"已完成";default:return"未知状态"}},I=s=>{if(!s)return"未知";const t=new Date(s),e=t.getFullYear(),n=(t.getMonth()+1).toString().padStart(2,"0"),i=t.getDate().toString().padStart(2,"0"),u=t.getHours().toString().padStart(2,"0"),b=t.getMinutes().toString().padStart(2,"0");return`${e}-${n}-${i} ${u}:${b}`},D=()=>{if(!a.value||!a.value.start_charging_time)return 0;const s=new Date(a.value.start_charging_time),e=w.value-s;return Math.floor(e/(1e3*60))},R=()=>{if(!a.value)return 0;let e=D()/300*100;return e=Math.min(e,99.9),e},K=()=>{y.value=setInterval(()=>{w.value=new Date,a.value&&a.value.status==="charging"&&w.value.getSeconds()%15===0&&v()},1e3)};return X(()=>{v(),K(),S.value=setInterval(()=>{v()},2*60*1e3)}),Z(()=>{y.value&&(clearInterval(y.value),y.value=null),S.value&&(clearInterval(S.value),S.value=null)}),(s,t)=>{const e=ue,n=ie,i=se,u=re,b=oe,W=ne,Y=le,j=ee,z=de;return p(),h("div",pe,[o(j,null,{header:l(()=>[r("div",_e,[t[1]||(t[1]=r("span",null,"排队状态",-1)),o(n,{onClick:C,loading:$.value},{default:l(()=>[o(e,null,{default:l(()=>[o(q(ge))]),_:1}),t[0]||(t[0]=c(" 刷新 "))]),_:1,__:[0]},8,["loading"])])]),default:l(()=>[ae((p(),h("div",null,[a.value?(p(),h("div",ve,[o(i,{title:V(),type:L(),description:N(),"show-icon":"",closable:!1},null,8,["title","type","description"]),r("div",fe,[o(W,{column:1,border:""},{default:l(()=>[o(u,{label:"充电桩"},{default:l(()=>[c(d(a.value.pile_name),1)]),_:1}),o(u,{label:"排队位置"},{default:l(()=>[c(" 第 "+d(a.value.position)+" 位 ",1)]),_:1}),o(u,{label:"总排队人数"},{default:l(()=>[c(d(a.value.total_in_queue)+" 人 ",1)]),_:1}),o(u,{label:"预计等待时间"},{default:l(()=>[c(d(a.value.estimated_time)+" 分钟 ",1)]),_:1}),o(u,{label:"充电请求时间"},{default:l(()=>[c(d(I(a.value.request_time)),1)]),_:1}),o(u,{label:"状态"},{default:l(()=>[o(b,{type:U(a.value.status)},{default:l(()=>[c(d(H(a.value.status)),1)]),_:1},8,["type"])]),_:1})]),_:1}),a.value.status==="charging"?(p(),h("div",me,[t[5]||(t[5]=r("h3",null,"充电进行中",-1)),r("div",he,[r("div",we,[t[2]||(t[2]=r("div",{class:"time-label"},"开始时间",-1)),r("div",ye,d(I(a.value.start_charging_time)),1)]),r("div",Se,[t[3]||(t[3]=r("div",{class:"time-label"},"当前时间",-1)),r("div",xe,d(B.value),1)]),r("div",Te,[t[4]||(t[4]=r("div",{class:"time-label"},"已充电时长",-1)),r("div",$e,d(D())+"分钟",1)])]),r("div",be,[o(Y,{percentage:R(),"stroke-width":20,format:G=>`已充 ${G.toFixed(1)}%`},null,8,["percentage","format"])]),t[6]||(t[6]=r("div",{class:"charging-estimate"},[r("p",null,[r("i",{class:"el-icon-info"}),c(" 您可以随时结束充电，系统将按实际充电量计费。 ")])],-1))])):k("",!0),r("div",ke,[a.value.status==="waiting"?(p(),M(n,{key:0,type:"danger",onClick:P,loading:_.value},{default:l(()=>t[7]||(t[7]=[c(" 取消排队 ")])),_:1,__:[7]},8,["loading"])):k("",!0),a.value.status==="charging"?(p(),M(n,{key:1,type:"warning",onClick:A,loading:_.value},{default:l(()=>t[8]||(t[8]=[c(" 结束充电 ")])),_:1,__:[8]},8,["loading"])):k("",!0)])])])):(p(),h("div",Ee,[o(i,{title:"当前没有排队",type:"success",description:"您当前没有在任何充电桩排队，请前往充电请求页面申请充电","show-icon":"",closable:!1}),r("div",Ie,[o(n,{type:"primary",onClick:Q},{default:l(()=>[o(e,null,{default:l(()=>[o(q(ce))]),_:1}),t[9]||(t[9]=c(" 申请充电 "))]),_:1,__:[9]})])]))])),[[z,T.value]])]),_:1})])}}},Ve=J(De,[["__scopeId","data-v-a79ca7c4"]]);export{Ve as default};
