import{_ as K}from"./_plugin-vue_export-helper-BCEt7Ct6.js";/* empty css                        */import"./el-tooltip-l0sNRNKZ.js";/* empty css                     *//* empty css                *//* empty css                    *//* empty css               *//* empty css                  */import{r as h,F as O,am as j,a0 as X,c as _,o as m,d as n,w as r,K as Y,m as x,I as b,G as Z,Q as q,R as N,n as tt,J as et,ap as at,b as o,S as I,v as c,V as st,l as v,k as nt,a5 as rt,aa as ot,ab as lt,t as it,x as ut,a7 as ct}from"./index-DURBC1W6.js";import{i as dt}from"./index-Bb6yjXMn.js";const mt={class:"monitoring"},pt={class:"card-header"},gt={class:"pile-info"},_t={class:"pile-header"},ft={class:"pile-details"},ht={class:"detail-item"},vt={class:"value"},yt={class:"detail-item"},wt={class:"value"},bt={class:"detail-item"},xt={class:"value"},Ct={key:0,class:"detail-item"},$t={class:"value"},kt={key:1,class:"detail-item"},Tt={class:"value"},Mt={key:0,class:"pile-actions"},It={class:"queue-status"},Lt={class:"queue-header"},Et={__name:"Monitoring",setup(Pt){const C=h(),L=h(!1);let $=null,y=null;const p=h([]),k=h([]),E=h([]),f=h([]),D=e=>({charging:"success",idle:"info",fault:"danger",maintenance:"warning"})[e]||"info",V=e=>({charging:"充电中",idle:"空闲",fault:"故障",maintenance:"维护中"})[e]||"未知",A=e=>({"pile-charging":e==="charging","pile-idle":e==="idle","pile-fault":e==="fault","pile-maintenance":e==="maintenance"}),B=e=>({error:"danger",warning:"warning",info:"info"})[e]||"info",P=async()=>{L.value=!0;try{await Promise.all([T(),R(),F()])}catch(e){console.error("获取监控数据失败:",e),x.error("获取监控数据失败")}finally{L.value=!1}},T=async()=>{try{const e=await b.get("/admin/piles");p.value=await Promise.all(e.map(async t=>{const l=Q(t),a=z(t);let u=null,i=null;try{const g=(await b.get(`/admin/piles/${t.id}/queue`)).find(M=>M.status==="charging");g&&(u=`用户${g.user_id}`,i=new Date(g.start_charging_time).toLocaleTimeString())}catch{}return{id:t.pile_number,name:`${t.charging_mode==="fast"?"快充桩":"慢充桩"}-${t.pile_number}`,status:t.status,power:l,voltage:t.charging_mode==="fast"?380:220,current:a,user:u,startTime:i,originalId:t.id,...t}})),W()}catch(e){console.error("获取充电桩状态失败:",e)}},R=async()=>{try{const e=await b.get("/admin/piles");k.value=await Promise.all(e.map(async t=>{try{const l=await b.get(`/admin/piles/${t.id}/queue`);return{pileId:t.pile_number,pileName:`${t.charging_mode==="fast"?"快充桩":"慢充桩"}-${t.pile_number}`,queueLength:l.length}}catch{return{pileId:t.pile_number,pileName:`${t.charging_mode==="fast"?"快充桩":"慢充桩"}-${t.pile_number}`,queueLength:0}}}))}catch(e){console.error("获取队列数据失败:",e)}},F=async()=>{const e=new Date().toLocaleTimeString(),t=p.value.filter(a=>a.status==="fault"),l=k.value.filter(a=>a.queueLength>3);E.value=[...t.map(a=>({time:e,type:"故障警报",level:"error",pile:a.id,message:`充电桩 ${a.id} 发生故障，已停止服务`,status:"pending"})),...l.map(a=>({time:e,type:"排队警报",level:"warning",pile:a.pileId,message:`充电桩 ${a.pileId} 排队人数较多 (${a.queueLength}人)`,status:"pending"}))]},Q=e=>{if(e.status!=="charging")return 0;const t=e.charging_mode==="fast"?60:30,l=(Math.random()-.5)*.2;return Math.max(0,Number((t*(1+l)).toFixed(1)))},z=e=>{if(e.status!=="charging")return 0;const t=e.charging_mode==="fast"?[40,50]:[15,20],l=(Math.random()-.5)*2,a=t[0]+Math.random()*(t[1]-t[0])+l;return Math.max(0,Number(a.toFixed(1)))},W=()=>{const t=new Date().toLocaleTimeString();f.value.length>=12&&f.value.shift(),f.value.push({time:t,data:p.value.reduce((l,a)=>(l[a.id]=a.power,l),{})}),S()},H=()=>{P(),x.success("数据已刷新")},U=async e=>{try{const t=p.value.find(l=>l.id===e);t&&(await b.post(`/admin/piles/${t.originalId}/stop`),x.success(`充电桩 ${e} 已停止充电`),await T())}catch(t){console.error("停止充电失败:",t),x.error("停止充电失败")}},G=()=>{C.value&&(y=dt(C.value),S())},S=()=>{if(!y||f.value.length===0)return;const e=f.value.map(a=>a.time),t=[...new Set(p.value.map(a=>a.id))],l=t.map(a=>{const u=f.value.map(d=>d.data[a]||0),i=p.value.find(d=>d.id===a);return{name:a,type:"line",data:u,smooth:!0,lineStyle:{width:2},itemStyle:{color:(i==null?void 0:i.status)==="charging"?"#67c23a":"#909399"}}});y.setOption({title:{text:"实时功率监控",left:"center"},tooltip:{trigger:"axis",formatter:function(a){let u=`时间: ${a[0].axisValue}<br/>`;return a.forEach(i=>{u+=`${i.seriesName}: ${i.value} kW<br/>`}),u}},legend:{top:30,data:t},grid:{top:60,left:50,right:30,bottom:50},xAxis:{type:"category",data:e,axisLabel:{rotate:45}},yAxis:{type:"value",name:"功率 (kW)",min:0},series:l})};return O(()=>{j(async()=>{G(),await P(),$=setInterval(()=>{T()},1e4)})}),X(()=>{$&&clearInterval($),y&&y.dispose()}),(e,t)=>{const l=it,a=nt,u=st,i=Y,d=et,g=Z,M=rt,w=lt,J=ot;return m(),_("div",mt,[n(i,null,{header:r(()=>[o("div",pt,[t[1]||(t[1]=o("span",null,"实时监控",-1)),n(a,{type:"primary",onClick:H},{default:r(()=>[n(l,null,{default:r(()=>[n(ut(ct))]),_:1}),t[0]||(t[0]=v(" 刷新 "))]),_:1,__:[0]})])]),default:r(()=>[n(g,{gutter:20,class:"status-cards"},{default:r(()=>[(m(!0),_(q,null,N(p.value,s=>(m(),tt(d,{span:6,key:s.id},{default:r(()=>[n(i,{class:at(["pile-card",A(s.status)])},{default:r(()=>[o("div",gt,[o("div",_t,[o("h3",null,c(s.name),1),n(u,{type:D(s.status)},{default:r(()=>[v(c(V(s.status)),1)]),_:2},1032,["type"])]),o("div",ft,[o("div",ht,[t[2]||(t[2]=o("span",{class:"label"},"功率:",-1)),o("span",vt,c(s.power)+" kW",1)]),o("div",yt,[t[3]||(t[3]=o("span",{class:"label"},"电压:",-1)),o("span",wt,c(s.voltage)+" V",1)]),o("div",bt,[t[4]||(t[4]=o("span",{class:"label"},"电流:",-1)),o("span",xt,c(s.current)+" A",1)]),s.user?(m(),_("div",Ct,[t[5]||(t[5]=o("span",{class:"label"},"用户:",-1)),o("span",$t,c(s.user),1)])):I("",!0),s.startTime?(m(),_("div",kt,[t[6]||(t[6]=o("span",{class:"label"},"开始时间:",-1)),o("span",Tt,c(s.startTime),1)])):I("",!0)]),s.status==="charging"?(m(),_("div",Mt,[n(a,{size:"small",type:"warning",onClick:St=>U(s.id)},{default:r(()=>t[7]||(t[7]=[v(" 停止充电 ")])),_:2,__:[7]},1032,["onClick"])])):I("",!0)])]),_:2},1032,["class"])]),_:2},1024))),128))]),_:1}),n(g,{gutter:20,style:{"margin-top":"20px"}},{default:r(()=>[n(d,{span:12},{default:r(()=>[n(i,null,{header:r(()=>t[8]||(t[8]=[o("span",null,"实时功率监控",-1)])),default:r(()=>[o("div",{ref_key:"powerChart",ref:C,style:{height:"300px"}},null,512)]),_:1})]),_:1}),n(d,{span:12},{default:r(()=>[n(i,null,{header:r(()=>t[9]||(t[9]=[o("span",null,"排队状况",-1)])),default:r(()=>[o("div",It,[(m(!0),_(q,null,N(k.value,s=>(m(),_("div",{class:"queue-item",key:s.pileId},[o("div",Lt,[o("span",null,c(s.pileName),1),n(u,{size:"small"},{default:r(()=>[v(c(s.queueLength)+"人排队",1)]),_:2},1024)]),n(M,{percentage:s.queueLength/5*100,status:s.queueLength>3?"exception":"success"},null,8,["percentage","status"])]))),128))])]),_:1})]),_:1})]),_:1}),n(g,{style:{"margin-top":"20px"}},{default:r(()=>[n(d,{span:24},{default:r(()=>[n(i,null,{header:r(()=>t[10]||(t[10]=[o("span",null,"系统警报",-1)])),default:r(()=>[n(J,{data:E.value,style:{width:"100%"}},{default:r(()=>[n(w,{prop:"time",label:"时间",width:"150"}),n(w,{prop:"type",label:"类型",width:"100"},{default:r(s=>[n(u,{type:B(s.row.level)},{default:r(()=>[v(c(s.row.type),1)]),_:2},1032,["type"])]),_:1}),n(w,{prop:"pile",label:"充电桩",width:"120"}),n(w,{prop:"message",label:"警报信息"}),n(w,{prop:"status",label:"状态",width:"100"},{default:r(s=>[n(u,{type:s.row.status==="resolved"?"success":"danger"},{default:r(()=>[v(c(s.row.status==="resolved"?"已解决":"待处理"),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])]),_:1})]),_:1})]),_:1})]),_:1})])}}},Wt=K(Et,[["__scopeId","data-v-26705cda"]]);export{Wt as default};
