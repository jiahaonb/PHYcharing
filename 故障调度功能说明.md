# 故障调度功能实现说明

## 功能概述

本系统实现了完整的充电桩故障调度功能，包含**暂留区**、**等候区**、**充电区**、**故障区**四个区域的智能调度管理。当充电桩发生故障时，系统会根据预设的调度原则自动处理受影响的车辆。

## 系统架构

### 四区结构
1. **暂留区**: 车辆的初始状态，未申请充电
2. **等候区**: 已申请充电，等待分配充电桩
3. **充电区**: 分为两个子状态
   - **排队**: 已分配充电桩，等待开始充电
   - **充电**: 正在充电中
4. **故障区**: 因充电桩故障而需要重新调度的车辆

### 数据模型扩展

在原有的队列状态基础上，新增了故障区状态：

```python
class QueueStatus(enum.Enum):
    WAITING = "waiting"          # 等候区等待
    QUEUING = "queuing"          # 充电区排队
    CHARGING = "charging"        # 正在充电
    COMPLETED = "completed"      # 充电完成
    CANCELLED = "cancelled"      # 已取消
    FAULT_WAITING = "fault_waiting"  # 故障区等待 (新增)
```

## 三大调度原则

### 原则1：优先调度
**触发条件**: 充电桩发生故障
**调度策略**: 
- 暂停等候区叫号服务
- 故障充电桩上的车辆优先分配到其他同类型充电桩
- 故障队列中全部车辆调度完毕后，重新开启等候区叫号服务

**实现逻辑**:
```python
def _fault_priority_reschedule(self, fault_vehicles, charging_mode):
    # 1. 暂停等候区叫号服务
    self._pause_waiting_area_service(charging_mode, "fault_priority")
    
    # 2. 为故障车辆优先分配充电桩
    for vehicle in fault_vehicles:
        best_pile = self._find_best_available_pile(vehicle)
        if best_pile:
            self._assign_to_charging_queue(vehicle, best_pile)
    
    # 3. 重新开启等候区叫号服务
    self._resume_waiting_area_service(charging_mode)
```

### 原则2：时间顺序调度
**触发条件**: 充电桩发生故障（选择此策略）
**调度策略**:
- 暂停等候区叫号服务
- 将其他同类型充电桩中尚未充电的车辆与故障队列车辆合并
- 按照排队号码先后顺序重新调度
- 完全调度完毕后，重新开启等候区叫号服务

**实现逻辑**:
```python
def _fault_time_order_reschedule(self, fault_vehicles, charging_mode):
    # 1. 暂停等候区叫号服务
    self._pause_waiting_area_service(charging_mode, "fault_time_order")
    
    # 2. 获取其他充电桩的排队车辆
    other_queued_vehicles = self._get_other_queued_vehicles(charging_mode)
    
    # 3. 合并并按排队号码排序
    all_vehicles = fault_vehicles + other_queued_vehicles
    all_vehicles.sort(key=lambda x: extract_queue_number(x.queue_number))
    
    # 4. 重新调度所有车辆
    self._reschedule_all_vehicles(all_vehicles)
    
    # 5. 重新开启等候区叫号服务
    self._resume_waiting_area_service(charging_mode)
```

### 原则3：故障恢复调度
**触发条件**: 充电桩故障恢复
**调度策略**:
- 检查其他同类型充电桩是否还有车辆排队
- 如有排队车辆，暂停等候区叫号服务
- 将其他充电桩的排队车辆按排队号码重新调度
- 调度完毕后，重新开启等候区叫号服务

**实现逻辑**:
```python
def handle_pile_recovery(self, pile_id):
    # 1. 恢复充电桩状态
    pile.status = ChargingPileStatus.NORMAL
    
    # 2. 检查其他充电桩排队情况
    other_queued_vehicles = self._get_other_queued_vehicles(pile.charging_mode)
    
    if other_queued_vehicles:
        # 3. 重新调度
        self._pause_waiting_area_service(pile.charging_mode, "recovery")
        self._reschedule_vehicles_by_queue_number(other_queued_vehicles)
        self._resume_waiting_area_service(pile.charging_mode)
```

## 核心特性

### 1. 排队号码保持不变
故障处理时，车辆的排队号码保持不变，确保公平性：
```python
# 保持原有的排队号码
new_queue_record = ChargingQueue(
    queue_number=original_queue_number,  # 保持原有排队号码
    user_id=vehicle.user_id,
    vehicle_id=vehicle.vehicle_id,
    charging_mode=vehicle.charging_mode,
    requested_amount=vehicle.requested_amount,
    status=QueueStatus.FAULT_WAITING  # 故障区车辆状态
)
```

### 2. 订单状态管理
故障时，原订单标记为已完成，重新生成新订单：
```python
# 将对应的充电记录标记为已完成
charging_record.status = "completed"

# 重新生成订单
new_charging_record = self._create_charging_order(
    user_id=vehicle.user_id,
    vehicle_id=vehicle.vehicle_id,
    queue_number=original_queue_number,  # 保持原排队号码
    license_plate=vehicle_info.license_plate,
    charging_mode=vehicle.charging_mode,
    charging_amount=vehicle.requested_amount
)
```

### 3. 故障区优先调度
在常规调度中，故障区车辆享有最高优先级：
```python
def _schedule_waiting_to_charging_queue(self, charging_mode):
    # 优先获取故障区的车辆，然后是等候区的车辆
    fault_vehicles = self._get_fault_waiting_vehicles(charging_mode)
    waiting_vehicles = self._get_waiting_vehicles(charging_mode)
    
    # 合并车辆列表，故障车辆优先
    all_vehicles = fault_vehicles + waiting_vehicles
```

## API接口

### 设置充电桩故障
```http
POST /api/v1/admin/piles/{pile_id}/fault?strategy=priority
```

**参数**:
- `pile_id`: 充电桩ID
- `strategy`: 调度策略 (`priority` 或 `time_order`)

### 恢复充电桩故障
```http
POST /api/v1/admin/piles/{pile_id}/recovery
```

**参数**:
- `pile_id`: 充电桩ID

## 测试验证

系统提供了完整的测试脚本 `test_fault_scheduling.py`，可以验证：

1. **优先调度测试**: 验证故障车辆优先分配
2. **时间顺序调度测试**: 验证按排队号码重新调度
3. **故障恢复测试**: 验证故障恢复后的重新调度
4. **故障区优先级测试**: 验证故障区车辆在常规调度中的优先级

### 运行测试
```bash
python test_fault_scheduling.py
```

## 业务价值

1. **公平性保障**: 排队号码不变，确保用户权益
2. **高效调度**: 故障车辆优先处理，减少等待时间
3. **系统稳定**: 完善的故障处理机制，提高系统可靠性
4. **用户体验**: 透明的故障处理流程，用户可实时了解状态

## 技术特点

1. **状态机设计**: 清晰的状态转换逻辑
2. **事务管理**: 保证数据一致性
3. **异常处理**: 完善的错误恢复机制
4. **日志记录**: 详细的操作日志，便于问题排查
5. **扩展性**: 支持多种调度策略，易于扩展

## 使用场景

1. **充电桩硬件故障**: 设备损坏需要维修
2. **充电桩软件故障**: 系统异常需要重启
3. **充电桩维护**: 定期保养维护
4. **紧急情况处理**: 安全事故等紧急情况

通过这套完整的故障调度机制，系统能够在各种异常情况下保持稳定运行，确保用户充电服务的连续性和公平性。 