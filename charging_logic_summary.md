# ⚡ 充电逻辑更新总结

## 🔄 每分钟更新机制

### 核心逻辑
系统每60秒自动执行以下更新：

1. **剩余时间减少1分钟**
2. **计算当前实际充电时长** = 当前时间 - 开始充电时间
3. **计算实际充电量** = min(充电桩功率 × 实际充电时长, 计划充电量)
4. **计算实际费用** = 实际充电量 × (电量单价 + 服务费单价)
5. **更新数据库记录**

### 📊 更新的数据字段

每分钟更新 `charging_records` 表的以下字段：

| 字段 | 说明 | 计算方式 |
|------|------|----------|
| `remaining_time` | 剩余时间（分钟） | 递减1分钟 |
| `actual_charging_amount` | 实际充电量（度） | min(功率×时长, 计划量) |
| `actual_electricity_fee` | 实际电费（元） | 实际充电量 × 电量单价 |
| `actual_service_fee` | 实际服务费（元） | 实际充电量 × 服务费单价 |
| `actual_total_fee` | 实际总费用（元） | 实际电费 + 实际服务费 |
| `charging_duration` | 充电时长（小时） | (当前时间 - 开始时间) / 3600 |
| `unit_price` | 电量单价 | 根据开始时间的时段确定 |
| `time_period` | 时段 | 峰时/平时/谷时 |

## 💰 新费用计算公式

**实际费用 = 实际充电量 × (电量单价 + 服务费单价)**

分解计算：
- 实际电费 = 实际充电量 × 电量单价
- 实际服务费 = 实际充电量 × 服务费单价
- 实际总费用 = 实际电费 + 实际服务费

## 🛑 自动停止条件

系统在以下情况下自动停止充电：

1. **充电完成**: 实际充电量 ≥ 计划充电量
2. **时间到期**: 剩余时间 ≤ 0

## 📈 示例数据变化

以快充桩（30kW）充电50度为例：

| 时间(分钟) | 实际充电量(度) | 电费(元) | 服务费(元) | 总费用(元) | 剩余时间(分钟) |
|------------|----------------|----------|------------|------------|----------------|
| 0          | 0.00          | 0.00     | 0.00       | 0.00       | 100            |
| 10         | 5.00          | 5.00     | 4.00       | 9.00       | 90             |
| 30         | 15.00         | 15.00    | 12.00      | 27.00      | 70             |
| 60         | 30.00         | 30.00    | 24.00      | 54.00      | 40             |
| 100        | 50.00         | 50.00    | 40.00      | 90.00      | 0              |

*注：电量单价1.0元/度，服务费单价0.8元/度*

## 🎯 业务价值

1. **实时费用反馈**: 用户随时了解当前费用
2. **精确充电控制**: 避免过度充电，节约成本
3. **自动化管理**: 减少人工干预，提高效率
4. **数据准确性**: 实时更新确保数据准确性

## 🔧 技术特性

- **定时执行**: 每60秒自动更新
- **异常处理**: 完善的错误恢复机制
- **事务管理**: 保证数据一致性
- **日志记录**: 详细的操作日志

## 🚀 使用场景

1. **用户端**: 实时查看当前充电费用
2. **管理端**: 监控所有充电订单的实时状态
3. **计费系统**: 精确的费用计算和结算
4. **运营分析**: 实时数据支持运营决策 